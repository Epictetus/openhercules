((function(){})).call(this),function(){}.call(this),function(){var a,b=Object.prototype.hasOwnProperty,c=function(a,c){function e(){this.constructor=a}for(var d in c)b.call(c,d)&&(a[d]=c[d]);return e.prototype=c.prototype,a.prototype=new e,a.__super__=c.prototype,a};a={lists:null,appId:"#app",backbone:{},selection:function(b){return b?this.selected=b:this.selected||(this.selected=a.root.children.first()),this.selected}},a.backbone.List=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.Model),b.prototype.change=function(){return this.save()},b.prototype.changeProperties=function(b){return this.set($.extend(b,{items:a.root.asJson().children})),this.propertiesView.render()},b.prototype.updateItems=function(){return this.set({items:a.root.asJson().children})},b}(),a.backbone.Lists=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.Collection),b.prototype.model=a.backbone.List,b.prototype.url="/lists",b}(),a.backbone.Item=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.Model),b.prototype.initialize=function(){var b,c,d,e,f;this.get("parent")?(this.parent=this.get("parent"),this.unset("parent",{silent:!0})):a.root&&(this.parent=a.root,this.parent.addChild(this)),this.get("body")||this.set({body:""},{silent:!0}),this.children=new a.backbone.ItemChildren;if(this.get("children")){e=this.get("children"),f=[];for(c=0,d=e.length;c<d;c++)b=e[c],b.parent=this,f.push(this.addChild(new a.backbone.Item(b)));return f}},b.prototype.events={change:"change"},b.prototype.asJson=function(){var a;return a=this.toJSON(),a.children=this.children.map(function(a){return a.asJson()}),a},b.prototype.updateList=function(){return a.mainList.updateItems()},b.prototype.change=function(){return this.view.setClasses(),this.view.setBody()},b.prototype.addChild=function(a){return this.children.add(a)},b.prototype.removeChild=function(a){return this.children.remove(a)},b.prototype.insertBefore=function(a){return a.parent.children.insertBefore(this,a)},b.prototype.insertAfter=function(a){return a.parent.children.insertAfter(this,a)},b.prototype.moveUp=function(){var a;if(this.previousSibling())return a=this.previousSibling(),$(this.view.el).insertBefore(a.view.el),this.parent.removeChild(this),this.insertBefore(a)},b.prototype.moveDown=function(){var a;if(this.nextSibling())return a=this.nextSibling(),$(this.view.el).insertAfter(a.view.el),this.parent.removeChild(this),this.insertAfter(a)},b.prototype.select=function(){return a.selection()&&a.selection().deselect(),a.selection(this),this.view.select()},b.prototype.deselect=function(){return a.selection(null),this.view.deselect()},b.prototype.next=function(){var b,c;return b=a.root.children.flatten(),c=b.indexOf(this),b[c+1]},b.prototype.previous=function(){var b,c;return b=a.root.children.flatten(),c=b.indexOf(this),b[c-1]},b.prototype.previousSibling=function(){return this.parent.children.before(this)},b.prototype.nextSibling=function(){return this.parent.children.after(this)},b.prototype.indent=function(){var a;if(this.previousSibling())return a=this.parent,this.setParent(this.previousSibling()),a.removeChild(this),this.parent.addChild(this),$(this.parent.view.childrenView.el).append(this.view.el),this.save()},b.prototype.outdent=function(){var b;if(this.parent!==a.root)return b=this.parent,this.setParent(this.parent.parent),b.removeChild(this),this.insertAfter(b),$(this.view.el).insertAfter(b.view.el),this.save()},b.prototype.setParent=function(a){return this.parent=a,this.set({parent_id:a.id})},b.prototype.parents=function(){var b,c;c=[],b=this.parent;while(b!==a.root)c.push(b),b=b.parent;return c},b.prototype.remove=function(){var a;return a=this.previous(),a&&a.select(),$(this.view.el).remove(),this.parent.children.remove(this),this.updateList()},b.prototype.toggleStatus=function(){return this.get("status")==="complete"?this.setIncomplete():this.setComplete()},b.prototype.setIncomplete=function(){var a,b,c,d;this.set({status:"incomplete"}),d=this.parents();for(b=0,c=d.length;b<c;b++)a=d[b],a.setIncomplete();return this.view.status.attr("checked",!1),this.view.setClasses(),this.save()},b.prototype.setComplete=function(){var a,b,c,d;this.set({status:"complete"}),d=this.children.flatten();for(b=0,c=d.length;b<c;b++)a=d[b],a.setComplete();return this.view.status.attr("checked",!0),this.view.setClasses(),this.save()},b.prototype.save=function(){return this.updateList()},b}(),a.backbone.ItemChildren=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.Collection),b.prototype.model=a.backbone.Item,b.prototype.before=function(a){return this.inRelationToItem(a,-1)},b.prototype.after=function(a){return this.inRelationToItem(a,1)},b.prototype.insertBefore=function(a,b){var c;return a.parent.removeChild(a),this.add(a),this.models.pop(),c=this.indexOf(b),this.models.splice(c,0,a)},b.prototype.insertAfter=function(a,b){var c;return a.parent.removeChild(a),this.add(a),this.models.pop(),c=this.indexOf(b),this.models.splice(c+1,0,a)},b.prototype.inRelationToItem=function(a,b){var c;return c=this.at(this.indexOf(a)+b),c},b.prototype.flatten=function(){var a;return a=[],this.each(function(b){a.push(b);if(b.children.length)return _.each(b.children.flatten(),function(b){return a.push(b)})}),a},b}(),a.backbone.ItemFormView=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.View),b.prototype.tagName="form",b.prototype.template=_.template("<input type='text' value='' />"),b.prototype.events={submit:"submit",keydown:"handleKey","keydown input":"handleInputKey","blur input":"stopEditing"},b.prototype.submit=function(){return this.stopEditing(),a.mainList.view.newItem(),!1},b.prototype.stopEditing=function(){var a;return a=this.$("input").val(),this.model.set({body:a}),this.model.save(),this.model.view.switchToShow()},b.prototype.handleKey=function(b){var c;c=b.keyCode.toString();if(c==="27")return this.stopEditing();if(c==="13")return this.stopEditing(),a.mainList.view.newItem()},b.prototype.handleInputKey=function(b){var c,d,e;c=b.keyCode.toString();if(c==="27")return this.stopEditing(),!1;if(c==="38")return e=a.selection().previous(),e&&(this.stopEditing(),e.select(),e.view.switchToForm()),!1;if(c==="40")return d=a.selection().next(),d&&(this.stopEditing(),d.select(),d.view.switchToForm()),!1},b.prototype.render=function(){return $(this.el).html(this.template()),this.$("input:first").val(this.model.get("body")),this},b}(),a.backbone.ItemView=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.View),b.prototype.tagName="li",b.prototype.template=_.template("<div class='item'><div class='body'></div></div>"),b.prototype.initialize=function(){return this.model.view=this},b.prototype.events={'change input[type="checkbox"]:first':"changeStatus","click .item.selected":"preventFurtherClicks","click .item:first":"click","dblclick .item:first":"switchToForm"},b.prototype.changeStatus=function(){return this.status.is(":checked")?this.model.setComplete():this.model.setIncomplete()},b.prototype.click=function(){return this.model.select()},b.prototype.preventFurtherClicks=function(a){return a.stopImmediatePropagation()},b.prototype.dblclick=function(){return this.switchToForm()},b.prototype.setClasses=function(){this.item.attr("class","item"),this.item.addClass(this.model.get("status")),this.item.addClass(this.model.get("item_type"));if(a.selected===this.model)return this.item.addClass("selected")},b.prototype.select=function(){return this.item.addClass("selected")},b.prototype.deselect=function(){return this.$("form").length&&this.form.submit(),this.item.removeClass("selected")},b.prototype.setBody=function(){return this.body.html(this.model.get("body")+"&nbsp;")},b.prototype.render=function(){var b;return b=this,$(this.el).html(this.template(this.model.toJSON())),this.item=$(this.el).children(".item"),this.body=this.item.children(".body"),this.setBody(),this.status=$("<input type='checkbox' />"),this.model.get("status")==="complete"?this.status.attr("checked",!0):this.status.attr("checked",!1),$(this.item).prepend(this.status),this.childrenView=new a.backbone.ItemChildrenView({model:this.model}),$(this.el).append(this.childrenView.render().el),this.setClasses(),this},b.prototype.switchToForm=function(){return this.form=new a.backbone.ItemFormView({model:this.model}),this.body.replaceWith(this.form.render().el),$(this.form.el).find("input").focus()},b.prototype.switchToShow=function(){return this.setBody(),$(this.form.el).replaceWith(this.body),this.model.select()},b}(),a.backbone.ItemChildrenView=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.View),b.prototype.tagName="ul",b.prototype.className="children",b.prototype.render=function(){var b;return b=this,this.model.children.each(function(c){var d;return d=new a.backbone.ItemView({model:c}),$(b.el).append(d.render().el)}),this},b}(),a.backbone.ListPropertiesView=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,Backbone.View),a.prototype.render=function(){return this.$(".name").text(this.model.get("name")),$(".list-"+this.model.get("id")+" a").text(this.model.get("name")),this.$(".notes").text(this.model.get("notes")),this},a}(),a.backbone.ListPropertiesFormView=function(){function a(){a.__super__.constructor.apply(this,arguments)}return c(a,Backbone.View),a.prototype.events={"click .primary":"submit","form submit":"submit","click .cancel":"cancel"},a.prototype.render=function(){return this.$(".name").val(this.model.get("name")),this.$(".notes").val(this.model.get("notes")),this},a.prototype.submit=function(){return this.model.changeProperties({name:this.$(".name").val(),notes:this.$(".notes").val()}),$("#properties-form").modal("hide"),!1},a.prototype.cancel=function(){return this.render(),$("#properties-form").modal("hide")},a}(),a.backbone.ListView=function(){function b(){b.__super__.constructor.apply(this,arguments)}return c(b,Backbone.View),b.prototype.tagName="ul",b.prototype.className="item-list",b.prototype.initialize=function(){return _.bindAll(this,"selectPrevious","selectNext","switchItem","toggleStatus","moveSelectionUp","moveSelectionDown","indentItem","outdentItem","newItem","deleteItem")},b.prototype.selectPrevious=function(){var b,c;return!a.selected&&a.selection()?a.selection().select():(b=a.selection())!=null&&(c=b.previous())!=null&&c.select(),!1},b.prototype.selectNext=function(){return!a.selected&&a.selection()?a.selection().select():a.selection()&&a.selection().next()&&a.selection().next().select(),!1},b.prototype.switchItem=function(){return a.selection().view.switchToForm()},b.prototype.toggleStatus=function(){return a.selection().toggleStatus(),!1},b.prototype.moveSelectionUp=function(b){return a.selection().moveUp(),!1},b.prototype.moveSelectionDown=function(b){return a.selection().moveDown(),!1},b.prototype.indentItem=function(){return a.selection().indent()},b.prototype.outdentItem=function(){return a.selection().outdent()},b.prototype.newItem=function(b){var c,d,e,f;return f=a.selection(),f?e=f.parent:e=a.root,c=new a.backbone.Item({parent:e}),d=new a.backbone.ItemView({model:c}),d.render(),f?b==="previous"?(c.insertBefore(f),$(c.view.el).insertBefore(f.view.el)):f.children.size()>0?(f=f.children.first(),c.insertBefore(f),$(c.view.el).insertBefore(f.view.el)):b==="indent"?(c.insertAfter(f),c.indent()):(c.insertAfter(f),$(c.view.el).insertAfter(f.view.el)):$(this.el).append(d.el),c.select(),_.defer(function(){return a.selection().view.switchToForm()})},b.prototype.deleteItem=function(){return a.selection().remove(),!1},b.prototype.render=function(){var b;return b=this,this.collection.each(function(c){var d;if(!c.get("parent_id"))return d=new a.backbone.ItemView({model:c}),$(b.el).append(d.render().el)}),this},b}(),a.keyBindings=function(){return $(document).bind("keydown","up",a.mainList.view.selectPrevious),$(document).bind("keydown","down",a.mainList.view.selectNext),$(document).bind("keydown","esc",a.mainList.view.switchItem),$(document).bind("keydown","ctrl+up",a.mainList.view.moveSelectionUp),$(document).bind("keydown","ctrl+down",a.mainList.view.moveSelectionDown),$(document).bind("keydown","space",a.mainList.view.toggleStatus),$(document).bind("keydown","return",function(){return a.mainList.view.newItem()}),$(document).bind("keydown","ctrl+return",function(){return a.mainList.view.newItem("indent")}),$(document).bind("keydown","shift+return",function(){return a.mainList.view.newItem("previous")}),$(document).bind("keydown","backspace",a.mainList.view.deleteItem),$(document).bind("keydown","del",a.mainList.view.deleteItem),$(document).bind("keydown","x",a.mainList.view.indentItem),$(document).bind("keydown","z",a.mainList.view.outdentItem),$(document).bind("keydown","p",function(){return $("#project").focus()})},a.setup=function(b){return $(function(){return a.setupList(b),$(a.appId).append(a.mainList.view.render().el),a.keyBindings(),a.mainList.view.selectNext()})},a.setupList=function(b){return a.lists=new a.backbone.Lists([{id:b._id,name:b.name,notes:b.notes,items:b.items}]),a.mainList=a.lists.at(0),a.setupItems(b.items),a.mainList.view=new a.backbone.ListView({collection:a.root.children}),a.mainList.propertiesView=new a.backbone.ListPropertiesView({model:a.mainList,el:$("#properties")}),a.mainList.propertiesFormView=new a.backbone.ListPropertiesFormView({model:a.mainList,el:$("#properties-form")})},a.setupItems=function(b){return a.root=new a.backbone.Item,_.each(b,function(b){return new a.backbone.Item(b)})},$(function(){return $(".cookie-user").click(function(){return confirm("Are you sure? You will not be able to recover your data unless you modify your account first.")}),$("#new").bind("shown",function(){return $("#new .name").focus()}),$("#new .primary").click(function(){return $("#new form").submit()}),$("#new .cancel").click(function(){return $("#new").modal("hide")})}),window.App=a}.call(this),$(document).ajaxSend(function(a,b,c){var d=$("meta[name='csrf-token']").attr("content");b.setRequestHeader("X-CSRF-Token",d)})